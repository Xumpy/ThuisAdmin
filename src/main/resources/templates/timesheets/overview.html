<html layout:decorator="views/layout" xmlns:th="http://www.thymeleaf.org" xmlns:tiles="http://www.thymeleaf.org">
    <body>
        <div layout:fragment="content">
            <div class="col-lg-12">
                <form class="form-horizontal" ng-submit="saveJobs()">
                    <div class="col-lg-1">
                        <input class="btn btn-primary" type="submit" value="Save"/>
                    </div>
                </form>
                <form class="form-horizontal" action="addGroups">
                    <div class="col-lg-1">
                        <input class="btn btn-primary" type="submit" value="Add Group"/>
                    </div>
                </form>
                <div class="col-lg-2">
                    <input data-provide="datepicker" data-date-format="mm/yyyy" class="datepicker form-control" id="beginDatum" placeholder="Select Month"
                           type="text" ng-model="Overview.month" />
                </div>
            </div>
            <table st-safe-src="bedragen" st-table="emptyBedragen" class="table table-striped table-hover ">
                <thead>
                    <tr>
                        <th>Project</th>
                        <th ng-repeat="jobs in Overview.allJobsInJobsGroup[0].jobs">{{jobs.jobDay}}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr ng-repeat="allJobsInJobsGroup in Overview.allJobsInJobsGroup">
                        <td>{{allJobsInJobsGroup.name}}</td>
                        <td ng-repeat="jobs in allJobsInJobsGroup.jobs">
                            <input ng-style="jobsColor(jobs)" ng-dblclick="jobsDetails(jobs)"
                                class="form-control input-sm" placeholder=".input-sm" type="text" ng-model="jobs.workedHours"/>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div id="dialog" class="modal-dialog" title="Basic dialog">
                <table st-safe-src="bedragen" st-table="emptyBedragen" class="table table-hover ">
                    <tr><td>Remarks:</td><td><input type="text" ng_model="jobInfo.remarks"/></td></tr>
                    <tr><td>Percentage:</td><td><input type="text" ng_model="jobInfo.percentage"/></td></tr>
                    <tr ng-repeat="tickedJob in jobInfo.tickedJobsDetail.tickedJobs">
                        <td>Ticked {{tickedJob.started == true ? "In" : "Out"}}</td><td>{{tickedJob.ticked}}</td>
                    </tr>
                    <tr><td>Total hours worked: </td><td>{{jobInfo.tickedJobsDetail.actualWorked}}</td></tr>
                </table>
            </div>

            <div id="dialogInvoiceBuilder" class="modal-dialog" title="Basic dialog">
                <div class="col-lg-12">
                    <label for="inputInvoiceId" class="col-lg-4 control-label">Invoice Id</label>
                    <div class="col-lg-8">
                        <input class="form-control" id="inputInvoiceId" ng-model="invoiceBuilder.invoiceId" placeholder="Invoice Id" type="text"/>
                    </div>
                </div>
            </div>

            <div id="overtimeHours" title="Overtime Hours">
                <table st-safe-src="overtimeHours" st-table="emptyOvertimeHours" class="table table-hover">
                    <tr ng-repeat="tickedOverview in tickedOverviewDetails">
                        <td>Project: </td><td>{{tickedOverview.key.name}}</td>
                        <td>Overtime in minutes: </td><td>{{(tickedOverview.value.actualWorked - tickedOverview.value.timesheetWorked)}}</td>
                        <td><a th:href="@{/timesheets/printTimesheet?jobsGroupId={{tickedOverview.key.pk_id}}&amp;month={{tempSelectMonth}}}">Print PDF</a></td>
                        <td><a ng-click="startInvoiceBuilder(tickedOverview.key.pk_id)">Invoice Builder</a></td>
                    </tr>
                </table>
            </div>
            <script th:inline="javascript">
                /*<![CDATA[*/
                $(function() {
                    $( "#dialog" ).hide();
                    $( "#dialogInvoiceBuilder" ).hide();
                });

                $(".datepicker").datepicker( {
                    format: "mm/yyyy",
                    viewMode: "months",
                    minViewMode: "months"
                });

                app.controller("fController", function($scope, $http) {
                    $scope.invoiceBuilder = {
                        invoiceId: ""
                    }

                    $http.post(/*[[@{/json/fetch_overview}]]*/).success(function(data){
                        $scope.Overview = data;
                        $scope.tempSelectMonth = data.month;

                        $http.post(/*[[@{/json/ticket_overview_month}]]*/, $scope.Overview.month).success(function(data, status){
                            if (status == 200) $scope.tickedOverviewDetails = data;
                        });
                    });

                    $scope.startInvoiceBuilder = function(groupId){
                        $scope.invoiceBuilder.groupId = groupId;
                        $scope.invoiceBuilder.month = $scope.Overview.month;
                        $('#dialogInvoiceBuilder').dialog({
                            title: "Invoice Builder",
                            width: 500,
                            buttons: { "OK": function() {
                                $http.post(/*[[@{/json/invoice_builder}]]*/, $scope.invoiceBuilder).success(function(data){
                                    $( "#dialogInvoiceBuilder" ).dialog("close");
                                    if (data.status == 500) bootbox.alert(data.message);
                                });
                            }}
                        }).prev(".ui-dialog-titlebar").css("background","#bf3e11");
                    }

                    $scope.saveJobs = function(){
                        $http.post(/*[[@{/json/save_jobs_overview}]]*/, $scope.Overview).success(function(data){
                            $scope.Overview = data;
                            $http.post(/*[[@{/json/ticket_overview_month}]]*/, $scope.Overview.month).success(function(data, status){
                                if (status == 200) $scope.tickedOverviewDetails = data;
                            });
                        });
                    }

                    $scope.$watchCollection('Overview.month', function(newValue, oldValue){
                        if (newValue !== undefined && newValue !== $scope.tempSelectMonth){
                            $http.post(/*[[@{/json/fetch_month}]]*/, $scope.Overview.month).success(function(data){
                                $scope.Overview = data;
                            });
                            $http.post(/*[[@{/json/ticket_overview_month}]]*/, $scope.Overview.month).success(function(data, status){
                                if (status == 200) $scope.tickedOverviewDetails = data;
                            });
                            $scope.tempSelectMonth = $scope.Overview.month;
                        }
                    });

                    $scope.jobsDetails = function(jobs){
                        $scope.jobInfo = jobs;
                        $('#dialog').dialog({
                            title: "Job Details",
                            width: 500,
                            buttons: { "OK": function() { $(this).dialog("close"); } }
                        }).prev(".ui-dialog-titlebar").css("background","#bf3e11");
                    }

                    $scope.jobsColor = function(jobs){
                        if (!(jobs.remarks === '' || jobs.remarks === null)){
                            return { 'background-color': '#bf3e11' }
                        }

                        if (jobs.weekendDay === true){
                            return { 'background-color': 'grey' };
                        }
                    }

                    $scope.printPDF = function(jobsGroup){
                        $http.get(/*[[@{/timesheets/printTimesheet}]]*/, jobsGroup, $scope.Overview.month);
                    }
                });
                /*]]>*/
            </script>
        </div>
    </body>
</html>
