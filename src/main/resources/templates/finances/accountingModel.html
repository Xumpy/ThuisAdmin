<html layout:decorator="views/layout" xmlns:th="http://www.thymeleaf.org" xmlns:tiles="http://www.thymeleaf.org">
    <body>
        <div layout:fragment="content">
            <div class="col-lg-12">
                <div class="col-lg-2">
                    <form class="form-horizontal" ng-submit="retrieveYear()">
                        <input class="btn btn-primary" type="submit" value="Retrieve Yaer"/>
                    </form>
                </div>
                <div class="col-lg-2">
                    <form class="form-horizontal" ng-submit="saveYear()">
                        <input class="btn btn-primary" type="submit" value="Save Year"/>
                    </form>
                </div>
            </div>

            <div class="col-lg-12">
                <label for="year" class="col-lg-1 control-label">Year</label>
                <div class="col-lg-2">
                    <input autocomplete="off" data-provide="datepicker" data-date-format="yyyy" class="datepicker form-control" id="year" placeholder="Start Date"
                           type="text" ng-model="model.startDate" />
                </div>
            </div>
            <div class="col-lg-12">
                <label class="col-lg-1 control-label">Selected Revenue</label>
                <div class="col-lg-2">
                    {{financial_year.selectedRevenue}}
                </div>
            </div>
            <div class="col-lg-12">
                <label for="actualRevenue" class="col-lg-1 control-label">Actual Revenue</label>
                <div class="col-lg-2">
                    <input autocomplete="off" class="form-control" id="actualRevenue" placeholder="Actual Revenue"
                           type="text" ng-model="financial_year.actualRevenue" />
                </div>
            </div>
            <div class="col-lg-12">
                <label class="col-lg-1 control-label">Selected Costs</label>
                <div class="col-lg-2">
                    {{financial_year.selectedCosts}}
                </div>
            </div>
            <div class="col-lg-12">
                <label for="actualCosts" class="col-lg-1 control-label">Actual Costs</label>
                <div class="col-lg-2">
                    <input autocomplete="off" class="form-control" id="actualCosts" placeholder="Actual Costs"
                           type="text" ng-model="financial_year.actualCosts" />
                </div>
            </div>

            <div class="col-lg-12" ng-repeat="(finYearCostTypeId, finYearCostTypeVal) in financial_year.financialYearCostTypes">
                <div class="col-lg-2">
                    <label class="col-lg-4 control-label">Cost Type</label>
                    <div class="col-lg-8">
                        {{finYearCostTypeVal.costType.type}}
                    </div>
                </div>
                <div class="col-lg-2">
                    <label class="col-lg-6 control-label">Selected Cost</label>
                    <div class="col-lg-6">
                        {{finYearCostTypeVal.selectedCosts}}
                    </div>
                </div>
                <div class="col-lg-2">
                    <label class="col-lg-6 control-label">Actual Cost</label>
                    <div class="col-lg-6">
                        {{finYearCostTypeVal.actualCosts}}
                    </div>
                </div>
                <div class="col-lg-2">
                    <input id="deleteCostType" class="btn btn-primary" type="button" ng-click="deleteCostType(finYearCostTypeVal)" value="Delete"/>
                </div>
            </div>

            <div class="col-lg-12">
                <div class="col-lg-4">
                    <select class="form-control" ng-model="costTypeRow.costType"
                            ng-options="governmentCostType.type for governmentCostType in governmentCostTypes track by governmentCostType.pkId">
                        <option value="">-- No Cost Type Selected --</option>
                    </select>
                </div>
                <div class="col-lg-2">
                    <input class="form-control" id="actualCost" placeholder="Actual Cost" type="text" ng-model="costTypeRow.actualCosts" />
                </div>
                <div class="col-lg-2">
                    <input id="addCostType" class="btn btn-primary" type="button" ng-click="addCostType()" value="Add"/>
                </div>
            </div>

            <div class="col-lg-12">
                <label class="col-lg-1 control-label">Total</label>
                <div class="col-lg-2">
                    {{financial_year.total}}
                </div>
            </div>

            <script th:inline="javascript">
                $(".datepicker").datepicker( {
                    format: "yyyy",
                    viewMode: "years",
                    minViewMode: "years"
                });

                function selectCostType($http, $scope){
                    var url_government_cost_types = /*[[@{/json/governmentCostTypes}]]*/;
                    $http.get(url_government_cost_types).success( function(data){
                        $scope.governmentCostTypes = data;
                    });
                }
                function selectFinancialYear($http, $scope){
                    var url_financial_year = /*[[@{/json/financial_year/}]]*/;
                        $http.get(url_financial_year + $scope.model.startDate).success( function(data){
                            $scope.financial_year = data;
                        });
                }
                function savaFinancialYear($http, $scope){
                    var url_financial_year = /*[[@{/json/financial_year}]]*/;
                    $http.post(url_financial_year, $scope.financial_year).success( function(data){
                        selectFinancialYear($http, $scope);
                    });
                }
                app.controller("fController", function($scope, $http) {
                    $scope.model = {
                        startDate: 2021
                    }
                    $scope.costTypeRow = {
                        costType: null,
                        actualCost: null
                    }
                    selectCostType($http, $scope);
                    selectFinancialYear($http, $scope);

                    $scope.saveYear = function(){
                        savaFinancialYear($http, $scope);
                    }
                    $scope.addCostType = function(){
                        $scope.financial_year.financialYearCostTypes.push($scope.costTypeRow);
                        savaFinancialYear($http, $scope);
                        $scope.costTypeRow = {
                            costType: null,
                            actualCost: null
                        }
                    }
                    $scope.deleteCostType = function(costType){
                        $scope.financial_year.financialYearCostTypes = $scope.financial_year.financialYearCostTypes.filter(function(item){
                            return item.costType.pkId != costType.costType.pkId
                        });
                        savaFinancialYear($http, $scope);
                    }
                    $scope.retrieveYear = function(){
                        selectFinancialYear($http, $scope);
                    }

                });
            </script>
        </div>
    </body>
</html>
